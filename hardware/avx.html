<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SIMD &mdash; SPIRAL  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Debugger" href="../debugger.html" />
    <link rel="prev" title="SMP/OpenMP" href="smp.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            SPIRAL
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gap3/index.html">GAP3 Language</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spiral_objects/index.html">SPIRAL Objects and Data Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/index.html">SPIRAL Infrastructure</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Special Hardware</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="smp.html">SMP/OpenMP</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">SIMD</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#targeting-simd-vector-instructions">Targeting SIMD Vector Instructions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#simple-example-intel-avx-4-way-double-precision">Simple Example: Intel AVX 4-way Double Precision</a></li>
<li class="toctree-l4"><a class="reference internal" href="#stepwise-code-generation">Stepwise Code Generation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#complex-vectorization-example">Complex Vectorization Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#tags">Tags</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#real-vectorization">Real Vectorization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#complex-vectorization">Complex Vectorization</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#vectorization-rules">Vectorization Rules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#simple-vectorization-rule-example">Simple Vectorization Rule Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="#formula-rewrite">Formula Rewrite</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#wrapping">Wrapping</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#vwrap-transformation">VWrap Transformation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#vwrap-in-context-of-search">VWrap in Context of Search</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#special-role-of-stride-permutations">Special Role of Stride Permutations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#tl-lift-stride-permutation-to-non-terminal-level">TL: Lift Stride Permutation to Non-Terminal Level</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tl-in-context-of-search">TL in Context of Search</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#architecture-specific-permutations">Architecture Specific Permutations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#looking-up-vectorized-implementations-for-tl">Looking up vectorized Implementations for TL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#simd-isa-database-and-bootstrapping-a-vector-architecture">SIMD ISA Database and Bootstrapping a Vector Architecture</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#isa-database-and-hashed-breakdowns">ISA Database and Hashed Breakdowns</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#generic-breakdown-rules-to-look-up-architecture-specific-code">Generic Breakdown Rules to Look Up Architecture Specific Code</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#stride-permutatiopn-identities-as-rules">Stride Permutatiopn Identities as Rules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">Generic Breakdown Rules to Look Up Architecture Specific Code</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#spl-and-spl-vector-objects">SPL And Σ-SPL Vector Objects</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#generate-the-example">Generate The Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="#inspecting-the-vector-objects">Inspecting the Vector Objects</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#vector-spl-objects">Vector SPL Objects</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#vector-tensor-spl-object">Vector Tensor SPL Object</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id3">Vector Σ-SPL Objects</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#vector-gather">Vector Gather</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#vector-rc-objects-manage-data-layout">Vector RC Objects: Manage Data Layout</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#vector-rc-class">Vector RC Class</a></li>
<li class="toctree-l4"><a class="reference internal" href="#vrc-vrcl-vrcr-vrclr">VRC, VRCL, VRCR, VRCLR</a></li>
<li class="toctree-l4"><a class="reference internal" href="#terminate-vrc-vrcl-vrcr-vrclr">Terminate VRC, VRCL, VRCR, VRCLR</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#vector-sumsgen-and-rewriting">Vector SumsGen and Rewriting</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#default-sumsgen-handles-vector-spl-to-spl">Default Sumsgen Handles Vector SPL to Σ-SPL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rewrite-rule-strategies">Rewrite Rule Strategies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compile-strategies">Compile Strategies</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#vector-codegen">Vector CodeGen</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vector-instructions">Vector Instructions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vector-strength-reduction-and-fixup-rules">Vector Strength Reduction and Fixup Rules</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vector-unparser">Vector Unparser</a></li>
<li class="toctree-l3"><a class="reference internal" href="#isa-definition">ISA Definition</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../debugger.html">Debugger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../profiler/index.html">Profiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gethelp.html">Getting Help with SPIRAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute.html">Contributing to SPIRAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bibliography.html">Further Reading</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">SPIRAL</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Special Hardware</a></li>
      <li class="breadcrumb-item active">SIMD</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/hardware/avx.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="simd">
<span id="id1"></span><h1><a class="toc-backref" href="#id4" role="doc-backlink">SIMD</a><a class="headerlink" href="#simd" title="Link to this heading"></a></h1>
<nav class="contents" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#simd" id="id4">SIMD</a></p>
<ul>
<li><p><a class="reference internal" href="#targeting-simd-vector-instructions" id="id5">Targeting SIMD Vector Instructions</a></p>
<ul>
<li><p><a class="reference internal" href="#simple-example-intel-avx-4-way-double-precision" id="id6">Simple Example: Intel AVX 4-way Double Precision</a></p></li>
<li><p><a class="reference internal" href="#stepwise-code-generation" id="id7">Stepwise Code Generation</a></p></li>
<li><p><a class="reference internal" href="#complex-vectorization-example" id="id8">Complex Vectorization Example</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#tags" id="id9">Tags</a></p>
<ul>
<li><p><a class="reference internal" href="#real-vectorization" id="id10">Real Vectorization</a></p></li>
<li><p><a class="reference internal" href="#complex-vectorization" id="id11">Complex Vectorization</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#vectorization-rules" id="id12">Vectorization Rules</a></p>
<ul>
<li><p><a class="reference internal" href="#simple-vectorization-rule-example" id="id13">Simple Vectorization Rule Example</a></p></li>
<li><p><a class="reference internal" href="#formula-rewrite" id="id14">Formula Rewrite</a></p>
<ul>
<li><p><a class="reference internal" href="#kronecker-commute" id="id15">Kronecker Commute</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#wrapping" id="id16">Wrapping</a></p>
<ul>
<li><p><a class="reference internal" href="#vwrap-transformation" id="id17">VWrap Transformation</a></p></li>
<li><p><a class="reference internal" href="#vwrap-in-context-of-search" id="id18">VWrap in Context of Search</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#special-role-of-stride-permutations" id="id19">Special Role of Stride Permutations</a></p>
<ul>
<li><p><a class="reference internal" href="#tl-lift-stride-permutation-to-non-terminal-level" id="id20">TL: Lift Stride Permutation to Non-Terminal Level</a></p></li>
<li><p><a class="reference internal" href="#tl-in-context-of-search" id="id21">TL in Context of Search</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#architecture-specific-permutations" id="id22">Architecture Specific Permutations</a></p>
<ul>
<li><p><a class="reference internal" href="#looking-up-vectorized-implementations-for-tl" id="id23">Looking up vectorized Implementations for TL</a></p></li>
<li><p><a class="reference internal" href="#simd-isa-database-and-bootstrapping-a-vector-architecture" id="id24">SIMD ISA Database and Bootstrapping a Vector Architecture</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#isa-database-and-hashed-breakdowns" id="id25">ISA Database and Hashed Breakdowns</a></p>
<ul>
<li><p><a class="reference internal" href="#generic-breakdown-rules-to-look-up-architecture-specific-code" id="id26">Generic Breakdown Rules to Look Up Architecture Specific Code</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#stride-permutatiopn-identities-as-rules" id="id27">Stride Permutatiopn Identities as Rules</a></p>
<ul>
<li><p><a class="reference internal" href="#id2" id="id28">Generic Breakdown Rules to Look Up Architecture Specific Code</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#spl-and-spl-vector-objects" id="id29">SPL And Σ-SPL Vector Objects</a></p>
<ul>
<li><p><a class="reference internal" href="#generate-the-example" id="id30">Generate The Example</a></p></li>
<li><p><a class="reference internal" href="#inspecting-the-vector-objects" id="id31">Inspecting the Vector Objects</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#vector-spl-objects" id="id32">Vector SPL Objects</a></p>
<ul>
<li><p><a class="reference internal" href="#vector-tensor-spl-object" id="id33">Vector Tensor SPL Object</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id3" id="id34">Vector Σ-SPL Objects</a></p>
<ul>
<li><p><a class="reference internal" href="#vector-gather" id="id35">Vector Gather</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#vector-rc-objects-manage-data-layout" id="id36">Vector RC Objects: Manage Data Layout</a></p>
<ul>
<li><p><a class="reference internal" href="#vector-rc-class" id="id37">Vector RC Class</a></p></li>
<li><p><a class="reference internal" href="#vrc-vrcl-vrcr-vrclr" id="id38">VRC, VRCL, VRCR, VRCLR</a></p></li>
<li><p><a class="reference internal" href="#terminate-vrc-vrcl-vrcr-vrclr" id="id39">Terminate VRC, VRCL, VRCR, VRCLR</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#vector-sumsgen-and-rewriting" id="id40">Vector SumsGen and Rewriting</a></p>
<ul>
<li><p><a class="reference internal" href="#default-sumsgen-handles-vector-spl-to-spl" id="id41">Default Sumsgen Handles Vector SPL to Σ-SPL</a></p></li>
<li><p><a class="reference internal" href="#rewrite-rule-strategies" id="id42">Rewrite Rule Strategies</a></p></li>
<li><p><a class="reference internal" href="#compile-strategies" id="id43">Compile Strategies</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#vector-codegen" id="id44">Vector CodeGen</a></p></li>
<li><p><a class="reference internal" href="#vector-instructions" id="id45">Vector Instructions</a></p></li>
<li><p><a class="reference internal" href="#vector-strength-reduction-and-fixup-rules" id="id46">Vector Strength Reduction and Fixup Rules</a></p></li>
<li><p><a class="reference internal" href="#vector-unparser" id="id47">Vector Unparser</a></p></li>
<li><p><a class="reference internal" href="#isa-definition" id="id48">ISA Definition</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="targeting-simd-vector-instructions">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Targeting SIMD Vector Instructions</a><a class="headerlink" href="#targeting-simd-vector-instructions" title="Link to this heading"></a></h2>
<section id="simple-example-intel-avx-4-way-double-precision">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">Simple Example: Intel AVX 4-way Double Precision</a><a class="headerlink" href="#simple-example-intel-avx-4-way-double-precision" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>opts := SIMDGlobals.getOpts(AVX_4x64f); # default: real vectorization
t := TRC(DFT(16)).withTags(opts.tags);
rt := RandomRuleTree(t, opts);
c := CodeRuleTree(rt, opts);
PrintCode(&quot;AVX_DFT16&quot;, c, opts);
</pre></div>
</div>
</section>
<section id="stepwise-code-generation">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">Stepwise Code Generation</a><a class="headerlink" href="#stepwise-code-generation" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>opts.tags;                              # what are the tags
opts.tags[1].v;                 # vector length
opts.tags[1].isa;                       # targeted ISA
opts.vector;                            # check out the options used
spl := SPLRuleTree(rt);         # There are SIMD SPL objects
s := SumsRuleTree(rt, opts);            # and a SMP ISum
InfinityNormMat(MatSPL(s) - MatSPL(t)); # correctness check
</pre></div>
</div>
</section>
<section id="complex-vectorization-example">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Complex Vectorization Example</a><a class="headerlink" href="#complex-vectorization-example" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>optsc := SIMDGlobals.getOpts(AVX_4x64f, # __m256d = (re,im,re,im)
        rec(realVect := false, cplxVect := true));
rtc := RandomRuleTree(t, optsc);        # complex vectorized DFT(16)
sc := SumsRuleTree(rtc, optsc);
cc := CodeRuleTree(rtc, optsc);         # far fewer shuffle operations
PrintCode(&quot;AVXcplx_DFT16&quot;, cc, optsc);
</pre></div>
</div>
</section>
</section>
<section id="tags">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Tags</a><a class="headerlink" href="#tags" title="Link to this heading"></a></h2>
<section id="real-vectorization">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">Real Vectorization</a><a class="headerlink" href="#real-vectorization" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># spiral-core\namespaces\spiral\paradigms\vector\tags.gi
Class(AVecReg, AGenericTag, rec(
        isReg := true, isRegCx := false, isVec := true,
        updateParams := meth(self)
                Checked(IsSIMD_ISA(self.params[1]));
                Checked(Length(self.params)=1);
                self.v := self.params[1].v; self.isa := self.params[1];
        end,
        container := (self, spl) &gt;&gt;
                paradigms.vector.sigmaspl.VContainer(spl, self.isa)
));
</pre></div>
</div>
</section>
<section id="complex-vectorization">
<h3><a class="toc-backref" href="#id11" role="doc-backlink">Complex Vectorization</a><a class="headerlink" href="#complex-vectorization" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Class(AVecRegCx, AVecReg, rec(
        updateParams := meth(self)
                Checked(IsSIMD_ISA(self.params[1]));
                Checked(Length(self.params)=1);
                self.v := self.params[1].v/2; self.isa := self.params[1];
        end,
        container := (self, spl) &gt;&gt;
                paradigms.vector.sigmaspl.VContainer(spl, self.isa.cplx()),
        isRegCx := true
));
</pre></div>
</div>
</section>
</section>
<section id="vectorization-rules">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">Vectorization Rules</a><a class="headerlink" href="#vectorization-rules" title="Link to this heading"></a></h2>
<section id="simple-vectorization-rule-example">
<h3><a class="toc-backref" href="#id13" role="doc-backlink">Simple Vectorization Rule Example</a><a class="headerlink" href="#simple-vectorization-rule-example" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># spiral-core\namespaces\spiral\paradigms\vector\breakdown.gi
NewRulesFor(TTensorI, rec(
AxI_vec := rec(
        forTransposition := false,
        applicable := nt -&gt; nt.hasTags() and IsVecVec(nt.params) and
                (nt.isTag(1,AVecReg) or nt.isTag(1,AVecRegCx)) and
                IsInt(nt.params[2]/nt.firstTag().v),
        children := nt -&gt; let(r := nt.params[2] / nt.firstTag().v,
                        isa := nt.firstTag().isa,
                        [[ When(r = 1,
                                When(nt.numTags() = 1,
                                        nt.params[1].setWrap(VWrap(isa)),
                                        nt.params[1].setWrap(
                                                Drop(nt.getTags(), 1)).setWrap(VWrap(isa))
                                ),
                                TTensorI(nt.params[1].setWrap(VWrap(isa)), r,
                                        AVec, AVec).withTags(Drop(nt.getTags(), 1))
                        )]]
                ),
                apply := (nt, c, cnt) -&gt; VTensor(c[1], nt.firstTag().v)
   )
));
</pre></div>
</div>
</section>
<section id="formula-rewrite">
<h3><a class="toc-backref" href="#id14" role="doc-backlink">Formula Rewrite</a><a class="headerlink" href="#formula-rewrite" title="Link to this heading"></a></h3>
<section id="kronecker-commute">
<h4><a class="toc-backref" href="#id15" role="doc-backlink">Kronecker Commute</a><a class="headerlink" href="#kronecker-commute" title="Link to this heading"></a></h4>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># spiral-core\namespaces\spiral\paradigms\vector\breakdown.gi
NewRulesFor(TTensorI, rec(
        IxA_vec := rec(forTransposition := false,
        applicable := nt -&gt; IsParPar(nt.params) and nt.hasTags() and
                (nt.isTag(1,AVecReg) or nt.isTag(1,AVecRegCx)) and
                IsInt(nt.params[2]/nt.firstTag().v),
        children := nt -&gt; let(pv := nt.getTags(), v := pv[1].v,
                isa := pv[1].isa, d := nt.params[1].dims(),
                [[
                        TL(d[1]*v, v, 1, 1).withTags(pv).setWrap(VWrapId),
                        When(Length(pv)=1, nt.params[1].setWrap(VWrap(isa)),
                                nt.params[1].setpv(Drop(pv, 1)).setWrap(VWrap(isa))),
                        TL(d[2]*v, d[2], 1, 1).withTags(pv).setWrap(VWrapId)
                ]]),
        apply := (nt, c, cnt) -&gt; let(
                l := nt.params[2] / nt.firstTag().v,
                A := c[1] * VTensor(c[2], nt.firstTag().v) * c[3],
                NoDiagPullin(When(l=1, A , Tensor(I(l), A))))
        )
));
</pre></div>
</div>
</section>
</section>
</section>
<section id="wrapping">
<h2><a class="toc-backref" href="#id16" role="doc-backlink">Wrapping</a><a class="headerlink" href="#wrapping" title="Link to this heading"></a></h2>
<section id="vwrap-transformation">
<h3><a class="toc-backref" href="#id17" role="doc-backlink">VWrap Transformation</a><a class="headerlink" href="#vwrap-transformation" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># spiral-core\namespaces\spiral\paradigms\vector\vwrap.gi
Class(VWrap, VWrapBase, rec(
        __call__ := (self,isa) &gt;&gt; Checked(IsSIMD_ISA(isa),
                WithBases(self, rec(operations:=PrintOps, isa:=isa))),
        wrap := (self,r,t,opts) &gt;&gt; let(
                isa := self.isa, v := isa.v,
                tt := When(t.isReal(),
                        @_Base(paradigms.vector.sigmaspl.VTensor(r.node, v), r),
                                paradigms.vector.breakdown.AxI_vec(
                                        TTensorI(TRC(t).withTags([AVecReg(isa)]), v,
                                                AVec, AVec).withTags([AVecReg(isa)]),
                                paradigms.vector.breakdown.TRC_VRCLR(
                                        TRC(t).withTags([AVecReg(isa)]), r))),
        print := self &gt;&gt; Print(self.name, &quot;(&quot;, self.isa, &quot;)&quot;),
));
</pre></div>
</div>
</section>
<section id="vwrap-in-context-of-search">
<h3><a class="toc-backref" href="#id18" role="doc-backlink">VWrap in Context of Search</a><a class="headerlink" href="#vwrap-in-context-of-search" title="Link to this heading"></a></h3>
<p>Used in DP to time sub-trees.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>opts := SIMDGlobals.getOpts(AVX_4x64f);
t := DFT(2).setWrap(VWrap(AVX_4x64f));
rt := RandomRuleTree(t, opts);
wrt := t.wrap.wrap(rt, t, opts);
SPLRuleTree(wrt);
</pre></div>
</div>
</section>
</section>
<section id="special-role-of-stride-permutations">
<h2><a class="toc-backref" href="#id19" role="doc-backlink">Special Role of Stride Permutations</a><a class="headerlink" href="#special-role-of-stride-permutations" title="Link to this heading"></a></h2>
<section id="tl-lift-stride-permutation-to-non-terminal-level">
<h3><a class="toc-backref" href="#id20" role="doc-backlink">TL: Lift Stride Permutation to Non-Terminal Level</a><a class="headerlink" href="#tl-lift-stride-permutation-to-non-terminal-level" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># spiral-core\namespaces\spiral\paradigms\common\nonterms.gi
Class(TL, Tagged_tSPL_Container, rec(
        abbrevs :=  [ (size, stride) -&gt; Checked(ForAll([size, stride],
                IsPosIntSym), [size, stride, 1, 1]),
                        (size, stride, left, right) -&gt;
                Checked(ForAll([size, stride, left, right], IsPosIntSym),
                        [size, stride, left, right]) ],
        __call__ := arg &gt;&gt; let(self := arg[1], args := Drop(arg, 1),
                Cond(args=[1,1,1,1], I(1), ApplyFunc(Inherited,args))),
        dims := self &gt;&gt;
                Replicate(2, self.params[1]*self.params[3]*self.params[4]),
        terminate := self &gt;&gt; Tensor(I(self.params[3]),
                L(self.params[1], self.params[2]), I(self.params[4])),
        transpose := self &gt;&gt; TL(self.params[1],
                self.params[1]/self.params[2], self.params[3],
                self.params[4]).withTags(self.getTags()),
));
</pre></div>
</div>
</section>
<section id="tl-in-context-of-search">
<h3><a class="toc-backref" href="#id21" role="doc-backlink">TL in Context of Search</a><a class="headerlink" href="#tl-in-context-of-search" title="Link to this heading"></a></h3>
<p>Used in DP to time sub-trees.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>t := TL(8,2,2,4);
t.terminate();
</pre></div>
</div>
</section>
</section>
<section id="architecture-specific-permutations">
<h2><a class="toc-backref" href="#id22" role="doc-backlink">Architecture Specific Permutations</a><a class="headerlink" href="#architecture-specific-permutations" title="Link to this heading"></a></h2>
<section id="looking-up-vectorized-implementations-for-tl">
<h3><a class="toc-backref" href="#id23" role="doc-backlink">Looking up vectorized Implementations for TL</a><a class="headerlink" href="#looking-up-vectorized-implementations-for-tl" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Import(paradigms.vector.sigmaspl);
opts := SIMDGlobals.getOpts(AVX_4x64f);
opts.breakdownRules.TL;
t := TL(16,4,1,1).withTags(opts.tags);  # a in-register perm
rt := RandomRuleTree(t, opts);
HashLookup(opts.baseHashes[1], t);      # the implementation is cached

s := SPLRuleTree(rt);
vp := Collect(s, VPerm)[1];             # SPL object carries its code
vp.code;                                # code generator refers to ISA
AVX_4x64f.rules;                        # ISA carries implementations
PrintCode(&quot;&quot;, vp.code(Y, X), opts);     # for in-register perms
</pre></div>
</div>
</section>
<section id="simd-isa-database-and-bootstrapping-a-vector-architecture">
<h3><a class="toc-backref" href="#id24" role="doc-backlink">SIMD ISA Database and Bootstrapping a Vector Architecture</a><a class="headerlink" href="#simd-isa-database-and-bootstrapping-a-vector-architecture" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>SIMD_ISA_DB;                    # central SIMD data base
SIMD_ISA_DB.installed();        # all the ISAs supported
Doc(AVX_4x64f);         # The ISA carries all the relevant info
Print(SIMD_ISA_DB.buildBases);  # How the base cases are built
AVX_4x64f.buildRules;           # bootstrapping function
SIMD_ISA_DB.getBases(AVX_4x64f);        # all the base cases needed
SIMD_ISA_DB.lookupBases(AVX_4x64f);     # and how they are implemented
</pre></div>
</div>
</section>
</section>
<section id="isa-database-and-hashed-breakdowns">
<h2><a class="toc-backref" href="#id25" role="doc-backlink">ISA Database and Hashed Breakdowns</a><a class="headerlink" href="#isa-database-and-hashed-breakdowns" title="Link to this heading"></a></h2>
<section id="generic-breakdown-rules-to-look-up-architecture-specific-code">
<h3><a class="toc-backref" href="#id26" role="doc-backlink">Generic Breakdown Rules to Look Up Architecture Specific Code</a><a class="headerlink" href="#generic-breakdown-rules-to-look-up-architecture-specific-code" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># spiral-core\namespaces\spiral\paradigms\vector\bases\tl_bases.gi
NewRulesFor(TL, rec(
        SIMD_ISA_Bases1 := rec(
                forTransposition := false,
                applicable := (self, t) &gt;&gt; t.isTag(1, AVecReg) and
                        let(isa := t.firstTag().isa, P:=t.params,
                                isa.active and ForAny(isa.supportedTL(),
                                e -&gt; _TL_applicable(e, P[1], P[2], P[3], P[4]))),
                apply := function(nt,C,cnt)
                        local isa, tl, ll, vprm, P;
                        P:=nt.params;
                        isa := nt.firstTag().isa;
                        tl := isa.getTL(P);
                        ll := P[3] / tl.perm.l;
                        vprm := tl.vperm;
                        return When(ll = 1, vprm,
                                BlockVPerm(ll, isa.v, vprm, tl.perm.spl));
                end,
        )
));
</pre></div>
</div>
</section>
</section>
<section id="stride-permutatiopn-identities-as-rules">
<h2><a class="toc-backref" href="#id27" role="doc-backlink">Stride Permutatiopn Identities as Rules</a><a class="headerlink" href="#stride-permutatiopn-identities-as-rules" title="Link to this heading"></a></h2>
<section id="id2">
<h3><a class="toc-backref" href="#id28" role="doc-backlink">Generic Breakdown Rules to Look Up Architecture Specific Code</a><a class="headerlink" href="#id2" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># spiral-core\namespaces\spiral\paradigms\common\breakdown.gi
NewRulesFor(TL, rec(
        IxLxI_kmn_n := rec (forTransposition := false,
                applicable := nt -&gt;
                        Length(DivisorsIntDrop(nt.params[1]/nt.params[2])) &gt; 0,
                children := nt -&gt; let(
                        N := nt.params[1], n := nt.params[2],
                        km := N/n, ml := DivisorsIntDrop(km),
                        l := nt.params[3], r := nt.params[4],
                        List(ml, m -&gt; let( k := km/m, [
                                        TL(k*n, n, l, r*m).withTags(nt.getTags()),
                                        TL(m*n, n, k*l, r).withTags(nt.getTags())
                                ]))
                        ),
                apply := (nt, c, cnt) -&gt; let(
                        spl := c[1] * c[2],
                        When(nt.params[1] = nt.params[2]^2,
                                SymSPL(spl),
                                spl
                        )
                )
));
</pre></div>
</div>
</section>
</section>
<section id="spl-and-spl-vector-objects">
<h2><a class="toc-backref" href="#id29" role="doc-backlink">SPL And Σ-SPL Vector Objects</a><a class="headerlink" href="#spl-and-spl-vector-objects" title="Link to this heading"></a></h2>
<section id="generate-the-example">
<h3><a class="toc-backref" href="#id30" role="doc-backlink">Generate The Example</a><a class="headerlink" href="#generate-the-example" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Import(paradigms.vector.sigmaspl);
opts := SIMDGlobals.getOpts(AVX_4x64f);
rt := RandomRuleTree(TRC(DFT(16)).withTags(opts.tags), opts);
s := SPLRuleTree(rt);                   # SPL Objects
ss := SumsRuleTree(rt, opts);   # Sigma-SPL Objects
</pre></div>
</div>
</section>
<section id="inspecting-the-vector-objects">
<h3><a class="toc-backref" href="#id31" role="doc-backlink">Inspecting the Vector Objects</a><a class="headerlink" href="#inspecting-the-vector-objects" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Collect(s, VTensor)[1]; # Vectorized Tensor(., I(v))
Collect(ss, VTensor)[1];        # Vectorized Tensor(., I(v))
Collect(s, VPerm)[1];           # Vectorized Prm(.)
Collect(s, BlockVPerm)[1];      # Vectorized Tensor(I(.), Prm(.))
Collect(s, VContainer)[1];      # Provides context for rewriting
Collect(s, VRC)[1];             # Carries interleaved complex format
Collect(ss, VGath)[1];          # Tensor(Gath(.), I(v))
Collect(ss, VScat)[1];          # Tensor(Scat(.), I(v))
Collect(ss, VRCDiag)[1];        # Vectorized Diag(.)
</pre></div>
</div>
</section>
</section>
<section id="vector-spl-objects">
<h2><a class="toc-backref" href="#id32" role="doc-backlink">Vector SPL Objects</a><a class="headerlink" href="#vector-spl-objects" title="Link to this heading"></a></h2>
<section id="vector-tensor-spl-object">
<h3><a class="toc-backref" href="#id33" role="doc-backlink">Vector Tensor SPL Object</a><a class="headerlink" href="#vector-tensor-spl-object" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># spiral-core\namespaces\spiral\paradigms\vector\sigmaspl\vtensor.gi
Class(VTensor, Tensor, rec(
        new := (self, L) &gt;&gt; SPL(WithBases(self, rec(
                _children := [L[1]],
                dimensions := When(IsBound(L[1].dims), L[1].dims(),
                L[1].dimensions) * L[2], vlen := L[2]))),
        from_rChildren := (self, rch) &gt;&gt; ObjId(self)(rch[1], self.vlen),
        print := (self,i,is) &gt;&gt; Print(self.name, &quot;(&quot;,
                self.child(1).print(i+is,is), &quot;, &quot;, self.vlen, &quot;)&quot;),
        toAMat := self &gt;&gt; Tensor(self.child(1), I(self.vlen)).toAMat(),
        sums := self &gt;&gt; Inherit(self, rec(_children :=
                [self.child(1).sums()])),
        isPermutation := False,
        dims := self &gt;&gt; self.child(1).dims() * self.vlen,
        needInterleavedLeft := False,
        needInterleavedRight := False,
        transpose := self &gt;&gt; VTensor(self.child(1).transpose(), self.vlen),
        isBlockTransitive := true,
        cannotChangeDataFormat := False,
));
</pre></div>
</div>
</section>
</section>
<section id="id3">
<h2><a class="toc-backref" href="#id34" role="doc-backlink">Vector Σ-SPL Objects</a><a class="headerlink" href="#id3" title="Link to this heading"></a></h2>
<section id="vector-gather">
<h3><a class="toc-backref" href="#id35" role="doc-backlink">Vector Gather</a><a class="headerlink" href="#vector-gather" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># spiral-core\namespaces\spiral\paradigms\vector\sigmaspl\gather.gi
Class(VGath, BaseVGath, SumsBase, rec(
        rChildren := self &gt;&gt; [self.func],
        rSetChild := rSetChildFields(&quot;func&quot;),
        from_rChildren := (self, rch) &gt;&gt; ObjId(self)(rch[1], self.v),
        new := (self, func, v) &gt;&gt; SPL(WithBases(self,
                rec(func := func, v := v))).setDims(),
        dims := self &gt;&gt; [self.v*self.func.domain(),
                self.v*self.func.range()],
        transpose := self &gt;&gt; VScat(self.func, self.v),
        print := (self,i,is) &gt;&gt; Print(self.name, &quot;(&quot;, self.func, &quot;, &quot;,
                self.v,&quot;)&quot;, self.printA()),
        toAMat := self &gt;&gt; let(v:=self.v, n :=
                EvalScalar(v*self.func.domain()),
                        N := EvalScalar(v*self.func.range()),
                        func := fTensor(self.func, fId(v)).lambda(),
                        AMatMat(List([0..n-1], row -&gt; BasisVec(N,
                                EvalScalar(func.at(row).ev()))))),
));
</pre></div>
</div>
</section>
</section>
<section id="vector-rc-objects-manage-data-layout">
<h2><a class="toc-backref" href="#id36" role="doc-backlink">Vector RC Objects: Manage Data Layout</a><a class="headerlink" href="#vector-rc-objects-manage-data-layout" title="Link to this heading"></a></h2>
<section id="vector-rc-class">
<h3><a class="toc-backref" href="#id37" role="doc-backlink">Vector RC Class</a><a class="headerlink" href="#vector-rc-class" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Class(VRC, RC, rec(
        toAMat := (self) &gt;&gt; AMatMat(RCMatCyc(MatSPL(self.child(1)))),
        new := meth(self, spl, v)
                local res;
                res := SPL(WithBases(self, rec(_children:=[spl], v:=v,
                                                                dimensions := spl.dimensions)));
                res.dimensions := res.dims();
                return res;
        end,
        print := (self, i, is) &gt;&gt; Print(self.__name__,
                &quot;(\n&quot;, Blanks(i+is), self.child(1).print(i+is,is), &quot;, &quot;,
        #&quot;\n&quot;, Blanks(i+is),
        self.v,
        #&quot;\n&quot;, Blanks(i),
        &quot;)&quot;, self.printA()),
        unroll := self &gt;&gt; self,
        transpose := self &gt;&gt; VRC(self.child(1).conjTranspose(), self.v),
        vcost := self &gt;&gt; self.child(1).vcost(),
        from_rChildren := (self, rch) &gt;&gt; ObjId(self)(rch[1], self.v)
));
</pre></div>
</div>
</section>
<section id="vrc-vrcl-vrcr-vrclr">
<h3><a class="toc-backref" href="#id38" role="doc-backlink">VRC, VRCL, VRCR, VRCLR</a><a class="headerlink" href="#vrc-vrcl-vrcr-vrclr" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>v1 := VRC(Tensor(I(2), F(2)), 4);       # Implicit data reorganization
MatSPL(v1);
v2 := VRCL(Tensor(I(2), F(2)), 4);      # The L and R encodes
MatSPL(v2);
v3 := VRCR(Tensor(I(2), F(2)), 4);      # which side goes from
MatSPL(v3);
v4 := VRCLR(Tensor(I(2), F(2)), 4);     # interleaved complex format to
MatSPL(v4);                             # block split complex format
</pre></div>
</div>
</section>
<section id="terminate-vrc-vrcl-vrcr-vrclr">
<h3><a class="toc-backref" href="#id39" role="doc-backlink">Terminate VRC, VRCL, VRCR, VRCLR</a><a class="headerlink" href="#terminate-vrc-vrcl-vrcr-vrclr" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Import(paradigms.vector.rewrite);
opts := SIMDGlobals.getOpts(AVX_4x64f);
# see how the format gets propagated down the tree
v5 := VRC(Tensor(I(2), F(2)) * Tensor(F(2), I(2)), 4);
RulesVRC(v5);
# when propagated to the leftmost/rightmost tree leaves, terminate
v6 := VRCL(VTensor(F(2), 4), 4);
v7 := Rewrite(v6, [RulesVRCTerm], opts);
# termnination inserts VPerms to implement local data format change
v8 := VRCR(VTensor(F(2), 4), 4);
v9 := Rewrite(v9, [RulesVRCTerm], opts);
</pre></div>
</div>
</section>
</section>
<section id="vector-sumsgen-and-rewriting">
<h2><a class="toc-backref" href="#id40" role="doc-backlink">Vector SumsGen and Rewriting</a><a class="headerlink" href="#vector-sumsgen-and-rewriting" title="Link to this heading"></a></h2>
<section id="default-sumsgen-handles-vector-spl-to-spl">
<h3><a class="toc-backref" href="#id41" role="doc-backlink">Default Sumsgen Handles Vector SPL to Σ-SPL</a><a class="headerlink" href="#default-sumsgen-handles-vector-spl-to-spl" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>opts := SIMDGlobals.getOpts(AVX_4x64f);
opts.sumsgen;
opts.sumsgen.VTensor;
opts.sumsgen.VPerm;
</pre></div>
</div>
</section>
<section id="rewrite-rule-strategies">
<h3><a class="toc-backref" href="#id42" role="doc-backlink">Rewrite Rule Strategies</a><a class="headerlink" href="#rewrite-rule-strategies" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>opts.formulaStrategies;
opts.formulaStrategies.sigmaSpl;
opts.formulaStrategies.preRC;
opts.formulaStrategies.postProcess;
</pre></div>
</div>
</section>
<section id="compile-strategies">
<h3><a class="toc-backref" href="#id43" role="doc-backlink">Compile Strategies</a><a class="headerlink" href="#compile-strategies" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>opts.compileStrategy;
Print(opts.vector.isa.fixProblems);
</pre></div>
</div>
</section>
</section>
<section id="vector-codegen">
<h2><a class="toc-backref" href="#id44" role="doc-backlink">Vector CodeGen</a><a class="headerlink" href="#vector-codegen" title="Link to this heading"></a></h2>
<p>Default Sumsgen handles SPL to Σ-SPL.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># spiral-core\namespaces\spiral\paradigms\vector\sigmaspl\codegen.gi
Class(VectorCodegen, DefaultCodegen, rec(
        VContainer := (self, o, y, x, opts) &gt;&gt;
                self(o.child(1), y, x, CopyFields(opts, rec(
                        vector := rec(
                                isa  := o.isa,
                                SIMD := LocalConfig.cpuinfo.SIMDname )))),
        VPrm_x_I := (self, o, y, x, opts) &gt;&gt;
                self(VTensor(Prm(o.func), o.v), y, x, opts),
        VPerm := (self, o, y, x, opts) &gt;&gt; o.code(y, x),
        VTensor := (self, o, y, x, opts) &gt;&gt; let(
                CastToVect := p -&gt; StripList(List(Flat([p]), e -&gt;
                tcast(TPtr(TVect(opts.vector.isa.t.t, o.vlen)), e))),
                self(o.child(1), CastToVect(y), CastToVect(x), opts)),
        VGath := (self, o, y, x, opts) &gt;&gt; Cond(IsUnalignedPtrT(x.t),
                self(VGath_u(fTensor(o.func, fBase(o.v, 0)), o.v), y, x, opts),
                self(VTensor(Gath(o.func), o.v), y, x, opts)),
        VScat := (self, o, y, x, opts) &gt;&gt; Cond(IsUnalignedPtrT(y.t),
                self(VScat_u(fTensor(o.func, fBase(o.v, 0)), o.v), y, x, opts),
                self(VTensor(Scat(o.func), o.v), y, x, opts))
));
</pre></div>
</div>
</section>
<section id="vector-instructions">
<h2><a class="toc-backref" href="#id45" role="doc-backlink">Vector Instructions</a><a class="headerlink" href="#vector-instructions" title="Link to this heading"></a></h2>
<p>Every ISA defines ISA specific instructions and polymorphic add,…</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># spiral-core\namespaces\spiral\platforms\avx\code.gi
# __m256d _mm256_insertf128_pd(__m256d a, __m128d b, int offset);
Class(vinsert_2l_4x64f, VecExp_4.binary(), rec(
        ev := self &gt;&gt; let(
                a := _unwrap(self.args[1].ev()),
                b := _unwrap(self.args[2].ev()),
                When( self.args[3].p[1] = 0,
                        b :: a{[3 .. 4]}, a{[1 .. 2]} :: b )),
        computeType := self &gt;&gt; self.args[1].t,
));

# __m256d _mm256_unpackhi_pd(__m256d a, __m256d b);
Class(vunpackhi_4x64f, VecExp_4.binary(), rec(
        semantic := (in1, in2, p) -&gt; [in1[2], in2[2], in1[4], in2[4]],
        ev := _evpack
));

#__m256 _mm256_blend_ps(__m256 m1, __m256 m2, const int mask);
Class(vblend_8x32f,  VecExp_8.binary(), rec(
        semantic := (in1, in2, p) -&gt;
        List( Zip2(TransposedMat([in1, in2]), p), e -&gt; e[1][e[2]]),
        params := self &gt;&gt; Replicate(8, [1,2]), ev := _evshuf2
));
</pre></div>
</div>
</section>
<section id="vector-strength-reduction-and-fixup-rules">
<h2><a class="toc-backref" href="#id46" role="doc-backlink">Vector Strength Reduction and Fixup Rules</a><a class="headerlink" href="#vector-strength-reduction-and-fixup-rules" title="Link to this heading"></a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># spiral-core\namespaces\spiral\platforms\avx\sreduce.gi
RewriteRules(FixCodeAVX, rec(
        fix_noneExp := Rule( noneExp, e -&gt; e.t.zero()),
        vpermf128_8x32f_to_vextract := Rule( [assign, [deref, @(1)],
                [vpermf128_8x32f, @(2), @(3), @(4)]],
                e -&gt; let( p := @(4).val.p,
                        a := [[@(2).val, [0]], [@(2).val, [1]], [@(3).val,
                        [0]], [@(3).val, [1]]],
                        dst := tcast(TPtr(TVect(T_Real(32), 4)), @(1).val),
                        chain(
                                assign(deref(dst),
                                        ApplyFunc(vextract_4l_8x32f, a[p[1]])),
                                assign( deref(dst+1),
                                        ApplyFunc(vextract_4l_8x32f, a[p[2]])))
                )),
        addsub_4x64f_to_mul := Rule( [addsub_4x64f, _0, @(1)],
                e -&gt; mul(e.t.value([-1,1,-1,1]), @(1).val)),
        addsub_8x32f_to_mul := Rule( [addsub_8x32f, _0, @(1)],
                e -&gt; mul(e.t.value([-1,1,-1,1,-1,1,-1,1]), @(1).val)),
        avx_add_addsub_vzero := Rule([add, @(1), [@(2, [addsub_4x64f,
                addsub_8x32f]), _0, @(3)]],
                e -&gt; ObjId(@(2).val)(@(1).val, @(3).val)),
));
</pre></div>
</div>
</section>
<section id="vector-unparser">
<h2><a class="toc-backref" href="#id47" role="doc-backlink">Vector Unparser</a><a class="headerlink" href="#vector-unparser" title="Link to this heading"></a></h2>
<p>Polymorphic Unparsing for standard icode, adds special instructions</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># spiral-core\namespaces\spiral\platforms\avx\unparse.gi
Class(AVXUnparser, SSEUnparser, rec(
        TVect := (self, t, vars, i, is) &gt;&gt; let(
                ctype := self.ctype(t, _isa(self)),
                Print(ctype, &quot; &quot;, self.infix(vars, &quot;, &quot;))),
        vpack := (self, o, i, is) &gt;&gt; Cond( _avxT(o.t, self.opts),
                        Print(&quot;_mm256_set_&quot;, self.ctype_suffix(o.t, _isa(self)),
                &quot;(&quot;, self.infix(Reversed(o.args), &quot;, &quot;), &quot;)&quot;),
                Inherited(o, i, is)),
        sub := (self, o, i, is) &gt;&gt; Cond( _avxT(o.t, self.opts), let(
                isa := _isa(self),
                sfx := self.ctype_suffix(o.t, isa),
                saturated := When(isa.isFixedPoint and
                        isa.saturatedArithmetic, &quot;s&quot;, &quot;&quot;),
                        self.printf(&quot;_mm256_sub$1_$2($3, $4)&quot;, [saturated, sfx,
                                o.args[1], o.args[2]])),
                Inherited(o, i, is)),
        vextract_2l_4x64f := (self, o, i, is) &gt;&gt;
                self.prefix(&quot;_mm256_extractf128_pd&quot;, o.args),
        vstore_2l_4x64f := (self, o, i, is) &gt;&gt;
                self.prefix(&quot;_mm256_extractf128_pd&quot;, o.args),
));
</pre></div>
</div>
</section>
<section id="isa-definition">
<h2><a class="toc-backref" href="#id48" role="doc-backlink">ISA Definition</a><a class="headerlink" href="#isa-definition" title="Link to this heading"></a></h2>
<p>ISA Definition file ties everyting together</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># spiral-core\namespaces\spiral\platforms\avx\isa.gi
Class(AVX_4x64f, AVX_Intel, rec(
        includes     := () -&gt; [&quot;&lt;include/omega64.h&gt;&quot;] :: _AVXINTRIN(),
        v       := 4,
        t       := TVect(T_Real(64), 4),
        ctype   := &quot;double&quot;,
        instr   := [ vunpacklo_4x64f, vunpackhi_4x64f, vshuffle_4x64f,
                vperm2_4x64f, vpermf128_4x64f, vperm_4x64f, vblend_4x64f ],
        mul_cx := (self, opts) &gt;&gt;
                ((y, x, c) -&gt; let( u1 := self.freshU(), u2 := self.freshU(),
                        u3 := self.freshU(),
                        decl([u1, u2, u3], chain(
                                assign(u1, mul(x, vunpacklo_4x64f(c, c))),
                                assign(u2, vshuffle_4x64f(x, x, [2,1,2,1])),
                                assign(u3, mul(u2, vunpackhi_4x64f(c, c))),
                                assign(y, addsub_4x64f(u1, u3)))))),
        svload_init := (vt) -&gt; [
        [ y,x,opts) -&gt; let(u1 := var.fresh_t(&quot;U&quot;, TVect(vt.t, 2)),
                        decl([u1], chain(
                                assign(u1, vload1sd_2x64f(x[1].toPtr(vt.t))),
                                assign(y, vinsert_2l_4x64f(vt.zero(), u1, [0]))))),
        ...
));
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="smp.html" class="btn btn-neutral float-left" title="SMP/OpenMP" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../debugger.html" class="btn btn-neutral float-right" title="Debugger" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, SPIRAL Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>