<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rewriting &mdash; SPIRAL  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Compiler" href="compiler.html" />
    <link rel="prev" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            SPIRAL
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gap3/index.html">GAP3 Language</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spiral_objects/index.html">SPIRAL Objects and Data Types</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">SPIRAL Infrastructure</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="breakdown.html">Breakdown Rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="search.html">Search</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Rewriting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pattern-matching">Pattern Matching</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#collect">Collect</a></li>
<li class="toctree-l4"><a class="reference internal" href="#simple-patterns">Simple Patterns</a></li>
<li class="toctree-l4"><a class="reference internal" href="#subtree-patterns">Subtree Patterns</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#substitutions">Substitutions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#substtopdown-substbottomup">SubstTopDown/SubstBottomUp</a></li>
<li class="toctree-l4"><a class="reference internal" href="#variable-substitutions">Variable Substitutions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#rules">Rules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#simple-rules">Simple Rules</a></li>
<li class="toctree-l4"><a class="reference internal" href="#complex-rules">Complex Rules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#associative-rules">Associative Rules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Simple Rules</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">Complex Rules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#rule-sets">Rule Sets</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#define-a-rule-set">Define a Rule Set</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-rules-to-existing-rule-set">Add Rules to Existing Rule Set</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-rule-sets">Using Rule Sets</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#rule-strategies">Rule Strategies</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#define-a-rule-strategy">Define a Rule Strategy</a></li>
<li class="toctree-l4"><a class="reference internal" href="#combining-rule-sets">Combining Rule Sets</a></li>
<li class="toctree-l4"><a class="reference internal" href="#use-of-rule-strategies">Use of Rule Strategies</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#general-mechanics">General Mechanics</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#interface-for-rewriting">Interface for Rewriting</a></li>
<li class="toctree-l4"><a class="reference internal" href="#unifying-interface-across-all-rewritable-objects">Unifying Interface Across All Rewritable Objects</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#implementing-recursive-descent-visitors">Implementing Recursive Descent: Visitors</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#simple-example">Simple Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="#visitors-used-in-standard-translation-flow">Visitors Used in Standard Translation Flow</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sumsgen">SumsGen</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-defaultsumsgen-visitor">The DefaultSumsGen Visitor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">Visitors Used in Standard Translation Flow</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#codegen">CodeGen</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-defaultcodegen-visitor">The DefaultCodegen Visitor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">Visitors Used in Standard Translation Flow</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#c-pretty-printer">C Pretty Printer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-cunparser-visitor">The CUnparser Visitor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">Visitors Used in Standard Translation Flow</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="compiler.html">Compiler</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../hardware/index.html">Special Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debugger.html">Debugger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../profiler/index.html">Profiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gethelp.html">Getting Help with SPIRAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute.html">Contributing to SPIRAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bibliography.html">Further Reading</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">SPIRAL</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">SPIRAL Infrastructure</a></li>
      <li class="breadcrumb-item active">Rewriting</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/infrastructure/rewrite.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="rewriting">
<span id="rewrite"></span><h1><a class="toc-backref" href="#id6" role="doc-backlink">Rewriting</a><a class="headerlink" href="#rewriting" title="Link to this heading"></a></h1>
<nav class="contents" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#rewriting" id="id6">Rewriting</a></p>
<ul>
<li><p><a class="reference internal" href="#pattern-matching" id="id7">Pattern Matching</a></p>
<ul>
<li><p><a class="reference internal" href="#collect" id="id8">Collect</a></p></li>
<li><p><a class="reference internal" href="#simple-patterns" id="id9">Simple Patterns</a></p></li>
<li><p><a class="reference internal" href="#subtree-patterns" id="id10">Subtree Patterns</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#substitutions" id="id11">Substitutions</a></p>
<ul>
<li><p><a class="reference internal" href="#substtopdown-substbottomup" id="id12">SubstTopDown/SubstBottomUp</a></p></li>
<li><p><a class="reference internal" href="#variable-substitutions" id="id13">Variable Substitutions</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#rules" id="id14">Rules</a></p>
<ul>
<li><p><a class="reference internal" href="#simple-rules" id="id15">Simple Rules</a></p></li>
<li><p><a class="reference internal" href="#complex-rules" id="id16">Complex Rules</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#associative-rules" id="id17">Associative Rules</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id18">Simple Rules</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id19">Complex Rules</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#rule-sets" id="id20">Rule Sets</a></p>
<ul>
<li><p><a class="reference internal" href="#define-a-rule-set" id="id21">Define a Rule Set</a></p></li>
<li><p><a class="reference internal" href="#add-rules-to-existing-rule-set" id="id22">Add Rules to Existing Rule Set</a></p></li>
<li><p><a class="reference internal" href="#using-rule-sets" id="id23">Using Rule Sets</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#rule-strategies" id="id24">Rule Strategies</a></p>
<ul>
<li><p><a class="reference internal" href="#define-a-rule-strategy" id="id25">Define a Rule Strategy</a></p></li>
<li><p><a class="reference internal" href="#combining-rule-sets" id="id26">Combining Rule Sets</a></p></li>
<li><p><a class="reference internal" href="#use-of-rule-strategies" id="id27">Use of Rule Strategies</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#general-mechanics" id="id28">General Mechanics</a></p>
<ul>
<li><p><a class="reference internal" href="#interface-for-rewriting" id="id29">Interface for Rewriting</a></p></li>
<li><p><a class="reference internal" href="#unifying-interface-across-all-rewritable-objects" id="id30">Unifying Interface Across All Rewritable Objects</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#implementing-recursive-descent-visitors" id="id31">Implementing Recursive Descent: Visitors</a></p>
<ul>
<li><p><a class="reference internal" href="#simple-example" id="id32">Simple Example</a></p></li>
<li><p><a class="reference internal" href="#visitors-used-in-standard-translation-flow" id="id33">Visitors Used in Standard Translation Flow</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#sumsgen" id="id34">SumsGen</a></p>
<ul>
<li><p><a class="reference internal" href="#the-defaultsumsgen-visitor" id="id35">The DefaultSumsGen Visitor</a></p></li>
<li><p><a class="reference internal" href="#id3" id="id36">Visitors Used in Standard Translation Flow</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#codegen" id="id37">CodeGen</a></p>
<ul>
<li><p><a class="reference internal" href="#the-defaultcodegen-visitor" id="id38">The DefaultCodegen Visitor</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id39">Visitors Used in Standard Translation Flow</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#c-pretty-printer" id="id40">C Pretty Printer</a></p>
<ul>
<li><p><a class="reference internal" href="#the-cunparser-visitor" id="id41">The CUnparser Visitor</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id42">Visitors Used in Standard Translation Flow</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
<section id="pattern-matching">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Pattern Matching</a><a class="headerlink" href="#pattern-matching" title="Link to this heading"></a></h2>
<section id="collect">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Collect</a><a class="headerlink" href="#collect" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>opts := SpiralDefaults;
s := SumsRuleTree(RandomRuleTree(DFT(8), opts), opts);
c := CodeSums(s, opts);

Collect(s, Scat);               # get list of scatter operations
Set(Collect(s, Value)); # get all unique values
</pre></div>
</div>
</section>
<section id="simple-patterns">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">Simple Patterns</a><a class="headerlink" href="#simple-patterns" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Collect(c, @(1, [add, sub, neg, mul])); # get all arith ops...
Collect(c, @(1, [add, sub, neg, mul], e-&gt;e.t=TReal)); #...on reals

List(Collect(s, @(1, ISum)), e-&gt;e.var); # all loop variables
Set(Collect(s, @@(1, Value,     # all values inside Blk objects
        (e, cx)-&gt;IsBound(cx.Blk) and Length(cx.Blk) &gt; 0)));
</pre></div>
</div>
</section>
<section id="subtree-patterns">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">Subtree Patterns</a><a class="headerlink" href="#subtree-patterns" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Collect(c, [deref, add, sub]);
Collect(c, [mul, @(1), sub]);
Collect(c, [mul, Value, ...]);
Collect(c, [mul, @(1), [sub, deref, @(2)]]);
Collect(c, [mul, @(1), [sub, @(2, deref, e-&gt;X in e.free()), @(3)]]);
</pre></div>
</div>
</section>
</section>
<section id="substitutions">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">Substitutions</a><a class="headerlink" href="#substitutions" title="Link to this heading"></a></h2>
<section id="substtopdown-substbottomup">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">SubstTopDown/SubstBottomUp</a><a class="headerlink" href="#substtopdown-substbottomup" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>opts := SpiralDefaults;
c := CodeSums(SumsRuleTree(RandomRuleTree(DFT(8), opts), opts), opts);

# Ordered substitution: traversal order can matter greatly
SubstTopDown(Copy(c), @(1, Value, e-&gt;e.v=1), e-&gt;V(25));
SubstBottomUp(Copy(c), @(1, Value, e-&gt;e.v=1), e-&gt;V(-25));
</pre></div>
</div>
</section>
<section id="variable-substitutions">
<h3><a class="toc-backref" href="#id13" role="doc-backlink">Variable Substitutions</a><a class="headerlink" href="#variable-substitutions" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>vars := Collect(c, @(1, var, e-&gt;e.t=TReal));    # all the real variables
SubstVars(Copy(c), rec((vars[1].id) := V(1.1)));        # substitute one

# record of assignment of consecutive numbers to all real variables
substrec := FoldR(Zip2(vars, [1..Length(vars)]),
        (a,b) -&gt; CopyFields(a, rec((b[1].id) := V(b[2]))), rec());
SubstVars(Copy(c), substrec);   # substitute them

# loop unrolling example
i := Ind(4);
c2 := loop(i, 4, assign(nth(X, i), i)); # loop to be unrolled
chain(List(c2.range,    # chain of partially evaluated loop iterations
        i-&gt;SubstVars(Copy(c2.cmd), rec((c2.var.id) := V(i)))));
</pre></div>
</div>
</section>
</section>
<section id="rules">
<h2><a class="toc-backref" href="#id14" role="doc-backlink">Rules</a><a class="headerlink" href="#rules" title="Link to this heading"></a></h2>
<section id="simple-rules">
<h3><a class="toc-backref" href="#id15" role="doc-backlink">Simple Rules</a><a class="headerlink" href="#simple-rules" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Rule([neg, [neg, @1]], e -&gt; @1.val);
Rule([add, Value, Value],
        e-&gt;Value.new(e.args[1].t, e.args[1].v + e.args[2].v));
Rule([im, [conj, @(1)]], x-&gt;-im(@(1).val));
Rule([IF, @(1), skip, skip], e -&gt; skip());

Rule([RC, @(1, Compose)], e -&gt; Compose(List(@(1).val.children(), RC)));
Rule([RC, @(1, Gath)], e -&gt; Gath(fTensor(@(1).val.func, fId(2))));

Rule([Tensor, ..., @(1,O), ...], e -&gt; O(Rows(e), Cols(e)));
</pre></div>
</div>
</section>
<section id="complex-rules">
<h3><a class="toc-backref" href="#id16" role="doc-backlink">Complex Rules</a><a class="headerlink" href="#complex-rules" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>_v0none := @(0).target([ Value, noneExp ]).cond(
        (e) -&gt; Cond(ObjId(e) = noneExp, true, isValueZero(e)));
_0noneOrZero :=(t) -&gt; When(
        ObjId(@(0).val) = noneExp, noneExp(t), t.zero());
Rule([mul, ..., _v0none, ...], e -&gt; _0noneOrZero(e.t));
Rule([@@(0,mul,(e,cx)-&gt;IsBound(cx.nth) and cx.nth&lt;&gt;[]), @(1), @(2,add)],
         e -&gt; ApplyFunc(add, List(@(2).val.args, a-&gt;@(1).val * a)));
Rule( [im, [mul, [cxpack, @(1), @(2)], [conj, [cxpack,
        @(3).cond(x-&gt;x=@(1).val), @(4).cond(x-&gt;x=@(2).val)]]]],
        e -&gt; e.t.zero() );
</pre></div>
</div>
</section>
</section>
<section id="associative-rules">
<h2><a class="toc-backref" href="#id17" role="doc-backlink">Associative Rules</a><a class="headerlink" href="#associative-rules" title="Link to this heading"></a></h2>
<section id="id1">
<h3><a class="toc-backref" href="#id18" role="doc-backlink">Simple Rules</a><a class="headerlink" href="#id1" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ARule(add, [ @(1,add) ], e -&gt; @1.val.args);
ARule(fTensor,  [@(1, fTensor) ], e -&gt; @(1).val.children());
ARule(fCompose, [@(1), fId ], e -&gt; [@(1).val]);

ARule(Compose, [ @(1, Prm), @(2, Prm) ],
         e -&gt; [ Prm(fCompose(@(2).val.func, @(1).val.func)) ])
ARule(Compose, [ @(1, Gath), @(2, [Gath, Prm]) ],
         e -&gt; [ Gath(fCompose(@(2).val.func, @(1).val.func)) ]);
</pre></div>
</div>
</section>
<section id="id2">
<h3><a class="toc-backref" href="#id19" role="doc-backlink">Complex Rules</a><a class="headerlink" href="#id2" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ARule(leq, [@(1, Value, x-&gt;x.v&lt;=0), [@(0,mul), @(2, Value, x-&gt;x.v&gt;0),
        @(3,var,IsLoopIndex)]], e -&gt; [@(0).val]);

ARule( Compose, [ @(1, [Prm, Scat, ScatAcc, Conj, ConjL, ConjR, ConjLR]),
        @(2, [RecursStep, Grp, BB, SUM, ISum, Data, COND]) ],
        e -&gt; [ CopyFields(@(2).val, rec(
                         _children :=  List(@(2).val._children, c -&gt; @(1).val * c),
                         dimensions := [Rows(@(1).val), Cols(@(2).val)] )) ]);

ARule(fCompose, [ @(1, L), [ @(3, fTensor),
        @(2).cond(e-&gt;range(e) = @(1).val.params[2] and domain(e)=1), ... ] ],
        e-&gt;[ fTensor(Copy(Drop(@(3).val.children(), 1)), Copy(@(2).val)) ]
</pre></div>
</div>
</section>
</section>
<section id="rule-sets">
<h2><a class="toc-backref" href="#id20" role="doc-backlink">Rule Sets</a><a class="headerlink" href="#rule-sets" title="Link to this heading"></a></h2>
<section id="define-a-rule-set">
<h3><a class="toc-backref" href="#id21" role="doc-backlink">Define a Rule Set</a><a class="headerlink" href="#define-a-rule-set" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># spiral-core\namespaces\spiral\code\sreduce.gi
Class(RulesStrengthReduce, RuleSet);
RewriteRules(RulesStrengthReduce, rec(
         leq_single := Rule([leq, @(1)], e-&gt; V_true),
         add_assoc  := ARule(add, [ @(1,add) ], e -&gt; @1.val.args),
# hundreds of rules
));
</pre></div>
</div>
</section>
<section id="add-rules-to-existing-rule-set">
<h3><a class="toc-backref" href="#id22" role="doc-backlink">Add Rules to Existing Rule Set</a><a class="headerlink" href="#add-rules-to-existing-rule-set" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># somewhere else in the source code
RewriteRules(RulesStrengthReduce, rec(  # add more rules
        logic_single := Rule([@(1, [logic_and, logic_or]), @1], e-&gt;@1.val)
));
</pre></div>
</div>
</section>
<section id="using-rule-sets">
<h3><a class="toc-backref" href="#id23" role="doc-backlink">Using Rule Sets</a><a class="headerlink" href="#using-rule-sets" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>RulesStrengthReduce.rules.leq_single;
opts := SpiralDefaults;
s := SPLRuleTree(RandomRuleTree(DFT(8), opts)).sums();
s := Rewrite(s, RulesSums, opts);
s := Rewrite(s, RulesDiag, opts);
s := RulesDiagStandalone(s);
</pre></div>
</div>
</section>
</section>
<section id="rule-strategies">
<h2><a class="toc-backref" href="#id24" role="doc-backlink">Rule Strategies</a><a class="headerlink" href="#rule-strategies" title="Link to this heading"></a></h2>
<section id="define-a-rule-strategy">
<h3><a class="toc-backref" href="#id25" role="doc-backlink">Define a Rule Strategy</a><a class="headerlink" href="#define-a-rule-strategy" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># spiral-core\namespaces\spiral\code\sreduce.gi
LibStrategy := [ StandardSumsRules, HfuncSumsRules ];
</pre></div>
</div>
</section>
<section id="combining-rule-sets">
<h3><a class="toc-backref" href="#id26" role="doc-backlink">Combining Rule Sets</a><a class="headerlink" href="#combining-rule-sets" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>StandardSumsRules := MergedRuleSet(
        RulesSums, RulesFuncSimp, RulesDiag, RulesDiagStandalone,
        RulesStrengthReduce, RulesRC, RulesII, OLRules
);
</pre></div>
</div>
</section>
<section id="use-of-rule-strategies">
<h3><a class="toc-backref" href="#id27" role="doc-backlink">Use of Rule Strategies</a><a class="headerlink" href="#use-of-rule-strategies" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>SpiralDefaults.formulaStrategies.sigmaSpl;
SpiralDefaults.formulaStrategies.rc;
SReduce := (c,opts) -&gt;  # handy shortcut
        ApplyStrategy(c, [RulesStrengthReduce], BUA, opts);

opts := SpiralDefaults;
s := SumsRuleTree(RandomRuleTree(DFT(4), opts), opts);
c := DefaultCodegen(s, Y, X, opts);
c := SubstTopDown(c, @(1, loop), e-&gt;e.unroll());
Collect(c, mul);
c := SReduce(c, opts);
Collect(c, mul);
</pre></div>
</div>
</section>
</section>
<section id="general-mechanics">
<h2><a class="toc-backref" href="#id28" role="doc-backlink">General Mechanics</a><a class="headerlink" href="#general-mechanics" title="Link to this heading"></a></h2>
<section id="interface-for-rewriting">
<h3><a class="toc-backref" href="#id29" role="doc-backlink">Interface for Rewriting</a><a class="headerlink" href="#interface-for-rewriting" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># spiral-core\namespaces\spiral\code\ir.gi
Class(deref, nth, rec(
        __call__ := (self, loc) &gt;&gt; Inherited(loc, TInt.value(0)),
        rChildren := self &gt;&gt; [self.loc],
        rSetChild := rSetChildFields(&quot;loc&quot;),
));
deref.from_rChildren;
</pre></div>
</div>
</section>
<section id="unifying-interface-across-all-rewritable-objects">
<h3><a class="toc-backref" href="#id30" role="doc-backlink">Unifying Interface Across All Rewritable Objects</a><a class="headerlink" href="#unifying-interface-across-all-rewritable-objects" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>c := deref(X);  # code objects
c.rChildren();  # get rewritable fields
c.rSetChild(1, Y);      # change a rewritable field

DFT.rChildren;          # Transform level
RandomRuleTree(DFT(4), SpiralDefaults).rChildren;       # ruletree level
F.rChildren;            # SPL level
L.rChildren;            # Permutations
Gath.rChildren; # Sigma-SPL
Lambda.rChildren;       # Lambda function
fId.rChildren;          # symbolic functions
add.rChildren;          # expressions
T_Real.rChildren;       # data types
</pre></div>
</div>
</section>
</section>
<section id="implementing-recursive-descent-visitors">
<h2><a class="toc-backref" href="#id31" role="doc-backlink">Implementing Recursive Descent: Visitors</a><a class="headerlink" href="#implementing-recursive-descent-visitors" title="Link to this heading"></a></h2>
<section id="simple-example">
<h3><a class="toc-backref" href="#id32" role="doc-backlink">Simple Example</a><a class="headerlink" href="#simple-example" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># spiral-core\namespaces\spiral\rewrite\visitor.gi
Class(LispGen, Visitor, rec(
        add := (self, o) &gt;&gt; Print(&quot;(+ &quot;, self(o.args[1]), &quot; &quot;,
                self(o.args[2]), &quot;)&quot;),
        mul := (self, o) &gt;&gt; Print(&quot;(* &quot;, self(o.args[1]), &quot; &quot;,
                self(o.args[2]), &quot;)&quot;),
        sub := (self, o) &gt;&gt; Print(&quot;(- &quot;, self(o.args[1]), &quot; &quot;,
                self(o.args[2]), &quot;)&quot;),
        var := (self, o) &gt;&gt; Print(&quot;(var &quot;, o.id, &quot;)&quot;),
        Value := (self, o) &gt;&gt; Print(&quot;(value &quot;, o.v, &quot;)&quot;)
));
LispGen(4*X+2);
</pre></div>
</div>
</section>
<section id="visitors-used-in-standard-translation-flow">
<h3><a class="toc-backref" href="#id33" role="doc-backlink">Visitors Used in Standard Translation Flow</a><a class="headerlink" href="#visitors-used-in-standard-translation-flow" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>opts := SpiralDefaults;
opts.sumsgen;
DefaultSumsGen;
opts.codegen;
DefaultCodegen;
opts.unparser;
CUnparser;
</pre></div>
</div>
</section>
</section>
<section id="sumsgen">
<h2><a class="toc-backref" href="#id34" role="doc-backlink">SumsGen</a><a class="headerlink" href="#sumsgen" title="Link to this heading"></a></h2>
<section id="the-defaultsumsgen-visitor">
<h3><a class="toc-backref" href="#id35" role="doc-backlink">The DefaultSumsGen Visitor</a><a class="headerlink" href="#the-defaultsumsgen-visitor" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># spiral-core\namespaces\spiral\sigma\sumsgen.gi
# all the fields
Filtered(RecFields(DefaultSumsGen), i-&gt;not IsSystemRecField(i));
Print(DefaultSumsGen.__call__);

# the recursive definitions needed for DFT
DefaultSumsGen.Compose;
Print(DefaultSumsGen.Tensor);
DefaultSumsGen.I;
DefaultSumsGen.F;
DefaultSumsGen.Diag;
DefaultSumsGen.L;
</pre></div>
</div>
</section>
<section id="id3">
<h3><a class="toc-backref" href="#id36" role="doc-backlink">Visitors Used in Standard Translation Flow</a><a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>opts := SpiralDefaults;
s := SPLRuleTree(RandomRuleTree(DFT(8), opts));
SumsSPL(s, opts);
opts.sumsgen(s, opts);

# legacy and backwards compatibility framework
F(2).sums();
Tensor(F(2), I(2)).sums();
</pre></div>
</div>
</section>
</section>
<section id="codegen">
<h2><a class="toc-backref" href="#id37" role="doc-backlink">CodeGen</a><a class="headerlink" href="#codegen" title="Link to this heading"></a></h2>
<section id="the-defaultcodegen-visitor">
<h3><a class="toc-backref" href="#id38" role="doc-backlink">The DefaultCodegen Visitor</a><a class="headerlink" href="#the-defaultcodegen-visitor" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># spiral-core\namespaces\spiral\compiler\codegen.gi
# all the fields
Filtered(RecFields(DefaultCodegen), i-&gt;not IsSystemRecField(i));
Print(DefaultCodegen.__call__);

# Some of the fields
Print(DefaultCodegen.Formula);
Print(DefaultCodegen.Compose);
DefaultCodegen.ISum;
Print(DefaultCodegen.Gath);
Print(DefaultCodegen.Scat);
DefaultCodegen.Diag;
</pre></div>
</div>
</section>
<section id="id4">
<h3><a class="toc-backref" href="#id39" role="doc-backlink">Visitors Used in Standard Translation Flow</a><a class="headerlink" href="#id4" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>opts := SpiralDefaults;
s := SumsRuleTree(RandomRuleTree(DFT(8), opts), opts);
# only translate Sigma-SPL to icode
opts.codegen(s, Y, X, opts);
# also invoke the basic block compiler
opts.codegen(Formula(s), Y, X, opts);
</pre></div>
</div>
</section>
</section>
<section id="c-pretty-printer">
<h2><a class="toc-backref" href="#id40" role="doc-backlink">C Pretty Printer</a><a class="headerlink" href="#c-pretty-printer" title="Link to this heading"></a></h2>
<section id="the-cunparser-visitor">
<h3><a class="toc-backref" href="#id41" role="doc-backlink">The CUnparser Visitor</a><a class="headerlink" href="#the-cunparser-visitor" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># spiral-core\namespaces\spiral\compiler\unparse.gi
# all the fields
Filtered(RecFields(CUnparser), i-&gt;not IsSystemRecField(i));
Filtered(RecFields(CUnparserBase), i-&gt;not IsSystemRecField(i));
Print(CUnparser.gen);

# Some of the fields
Print(CUnparser.loop);
CUnparser.deref;
CUnparser.add;
CUnparser.Value;
Print(CUnparser.decl);
CUnparser.chain;
</pre></div>
</div>
</section>
<section id="id5">
<h3><a class="toc-backref" href="#id42" role="doc-backlink">Visitors Used in Standard Translation Flow</a><a class="headerlink" href="#id5" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>opts := SpiralDefaults;
c := CodeRuleTree(RandomRuleTree(DFT(8), opts), opts);
# Print full header etc.
PrintCode(&quot;dft8&quot;, c, opts);
# unparser needs opts as context
Unparse(c.cmds[1].cmds[2].cmd,
        CopyFields(CUnparser, rec(opts:=opts)), 0, 1);
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="search.html" class="btn btn-neutral float-left" title="Search" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="compiler.html" class="btn btn-neutral float-right" title="Compiler" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, SPIRAL Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>